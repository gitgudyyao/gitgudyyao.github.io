---
title: "Epidemic Analysis Dashboard"
author: "Tan Ying Yao"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: rows
    vertical_layout: fill
    runtime: shiny
---

```{r setup, include=FALSE}
#------------------ Packages for Dashboard------------------
library(flexdashboard)
library(coronavirus)
library(ggplot2)
library(plotly)
library(broom)

data(coronavirus)

#magic magrittr
`%>%` <- magrittr::`%>%`
#------------------ Parameters for Colors ------------------
# Refer to colors here
# https://www.w3.org/TR/css-color-3/#svg-color
confirmed_color <- "orange"
active_color <- "#1f77b4"
recovered_color <- "forestgreen"
death_color <- "red"
#------------------ Data Cleaning------------------
# For Malaysia
df_msia <- coronavirus %>%
  dplyr::filter(country == "Malaysia") %>%
  dplyr::group_by(country, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(
    names_from = type,
    values_from = total
  ) %>%
  dplyr::mutate(unrecovered = confirmed - ifelse(is.na(recovered), 0, recovered) - ifelse(is.na(death), 0, death)) %>%
  dplyr::arrange(-confirmed) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(country = dplyr::if_else(country == "United Arab Emirates", "UAE", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "Mainland China", "China", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "North Macedonia", "N.Macedonia", country)) %>%
  dplyr::mutate(country = trimws(country)) %>%
  dplyr::mutate(country = factor(country, levels = country))
# For Malaysia Daily
df_msia_daily <- coronavirus %>%
  dplyr::filter(country == "Malaysia") %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(
    names_from = type,
    values_from = total
  ) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(active = confirmed - death - recovered) %>%
  dplyr::mutate(
    confirmed_cum = cumsum(confirmed),
    death_cum = cumsum(death),
    recovered_cum = cumsum(recovered),
    active_cum = cumsum(active)
  )

# For global
df <- coronavirus %>%
  dplyr::mutate(country = dplyr::if_else(country == "United Arab Emirates", "UAE", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "Mainland China", "China", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "North Macedonia", "N.Macedonia", country)) %>%
  dplyr::mutate(country = trimws(country)) %>%
  dplyr::mutate(country = factor(country, levels = unique(country)))
#For global data
df_daily <- coronavirus %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE),
                   .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from = type,
    values_from = total
  ) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(active = confirmed - death - recovered) %>%
  dplyr::mutate(
    confirmed_cum = cumsum(confirmed),
    death_cum = cumsum(death),
    recovered_cum = cumsum(recovered),
    active_cum = cumsum(active)
  )

df_tree <- df %>%
  dplyr::group_by(country, type) %>%
  dplyr::summarise(total = sum(cases), .groups = "drop") %>%
  dplyr::mutate(type = ifelse(type == "confirmed", "Confirmed", type),
                type = ifelse(type == "recovered", "Recovered", type),
                type = ifelse(type == "death", "Death", type)) %>%
  tidyr::pivot_wider(names_from = type, values_from = total) %>%
  dplyr::mutate(Active = Confirmed - Death - Recovered) %>%
  tidyr::pivot_longer(cols = -country, names_to = "type", values_to = "total")

df_world <- df_tree %>%
  dplyr::group_by(type) %>%
  dplyr::summarise(total = sum(total), .groups = "drop") %>%
  tidyr::pivot_wider(names_from = type, values_from = total)

names(df_world) <- tolower(names(df_world))
#Malaysia States only
df_state = read.csv("state.csv")

```

Global
=======================================================================
Row {data-width=400}
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}

valueBox(value = paste(format(df_world$confirmed, big.mark = ","), "", sep = " "), 
         caption = "Total Confirmed Cases", 
         icon = "fas fa-user-md", 
         color = confirmed_color)
```


### active {.value-box}

```{r}
valueBox(value = paste(format(df_world$active[1], big.mark = ","), " (",
                       round(100 * df_world$active[1] / df_world$confirmed[1], 1), 
                       "%)", sep = ""), 
         caption = "Active Cases", icon = "fas fa-ambulance", 
         color = active_color)
```

### recovered {.value-box}

```{r}
valueBox(value = paste(format(df_world$recovered[1] , big.mark = ","), " (",
                       round(100 * df_world$recovered[1] / df_world$confirmed[1], 1), 
                       "%)", sep = ""), 
         caption = "Recovered Cases", icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}

```{r}

valueBox(value = paste(format(df_world$death[1] , big.mark = ","), " (",
                       round(100 * df_world$death[1] / df_world$confirmed[1], 1), 
                       "%)", sep = ""),
         caption = "Death Cases", 
         icon = "fas fa-heart-broken", 
         color = death_color)
```


Row {data-width=400}
-----------------------------------------------------------------------

### **Daily Cumulative Cases by Type (Global)** 
    
```{r}
plotly::plot_ly(data = df_daily,
                x = ~ date,
                y = ~ active_cum, 
                name = 'Active', 
                fillcolor = active_color,
                type = 'scatter',
                mode = 'none', 
                stackgroup = 'one') %>%
  plotly::add_trace(y = ~ recovered_cum,
                    name = "Recovered",
                    fillcolor = recovered_color) %>%
  plotly::add_trace(y = ~ death_cum,
                    name = "Death",
                    fillcolor = death_color) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Cumulative Number of Cases"),
                 xaxis = list(title = "Date",
                              type = "date"),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")

```

### **Daily Cumulative Cases by Type (Global)** 
    
```{r}
df_rates <- df_tree %>%
  dplyr::filter(type != "Active") %>%
  tidyr::pivot_wider(names_from = "type", values_from = "total") %>%
  dplyr::mutate(recovery_rate = Recovered / Confirmed,
    death_rate = Death / Confirmed) 


bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- htmltools::div(style = list(background = fill, width = width, height = height))
  chart <- htmltools::div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  htmltools::div(style = list(display = "flex", alignItems = "center"), label, chart)
}

tbl <- reactable::reactable(df_rates,
                     pagination = FALSE,
                     highlight = TRUE,
                     height = 650,
                     sortable = TRUE,
                     borderless = TRUE,
                     defaultPageSize = nrow(df_rates),
                      defaultSortOrder = "desc",
                     defaultSorted = "Confirmed",
                     columns = list(
                       country = reactable::colDef(name = "Country", minWidth = 50, maxWidth = 100),
                       Confirmed = reactable::colDef(name = "Confirmed",  minWidth = 50, maxWidth = 150, defaultSortOrder = "desc"),
                       Recovered = reactable::colDef(name = "Recovered",  minWidth = 50, maxWidth = 100),
                       Death = reactable::colDef(name = "Death",  minWidth = 50, maxWidth = 100),
                       recovery_rate = reactable::colDef(name = "Recovery Rate",  minWidth = 50, maxWidth = 200,
                                                        defaultSortOrder = "desc",
                                                      cell = function(value) {
                                                        value <- paste0(format(round(value * 100, 2), nsmall = 1), "%")
                                                        bar_chart(value, width = value, fill = "green", background = "#e1e1e1")
                                                      },
                       align = "left"),
                       death_rate = reactable::colDef(name = "Death Rate",  
                                                      minWidth = 50, maxWidth = 200,
                                                      defaultSortOrder = "desc",
                                                      cell = function(value) {
                                                        value <- paste0(format(round(value * 100, 2), nsmall = 1), "%")
                                                        bar_chart(value, width = value, fill = "red", background = "#e1e1e1")
                                                      },
                       align = "left"))
)

library(htmltools)
htmltools::div(class = "standings",
  htmltools::div(class = "title",
    htmltools::h2("Total Number of Covid-19 Cases by Country"),
    "Click on columns to resort the table"
  ),
  tbl,
)

```

Malaysia
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}
valueBox(
  value = paste(format(sum(df_msia$confirmed), big.mark = ","), "", sep = " "),
  caption = "Total Confirmed Cases",
  icon = "fas fa-user-md",
  color = confirmed_color
)
```

### active {.value-box}

```{r}
valueBox(value = paste(format(sum(df_msia$unrecovered, na.rm = TRUE), big.mark = ","), " (",
                       round(100 * sum(df_msia$unrecovered, na.rm = TRUE) / sum(df_msia$confirmed), 1), 
                       "%)", sep = ""), 
         caption = "Active Cases", icon = "fas fa-ambulance", 
         color = active_color)
```

### recovered {.value-box}

```{r}
valueBox(value = paste(format(sum(df_msia$recovered, na.rm = TRUE), big.mark = ","), " (",
                       round(100 * sum(df_msia$recovered, na.rm = TRUE) / sum(df_msia$confirmed), 1), 
                       "%)", sep = ""), 
         caption = "Recovered Cases", icon = "fas fa-heartbeat", 
         color = recovered_color)
```  

### death {.value-box}

```{r}
valueBox(
  value = paste(format(sum(df_msia$death, na.rm = TRUE), big.mark = ","), " (",
    round(100 * sum(df_msia$death, na.rm = TRUE) / sum(df_msia$confirmed), 1),
    "%)",
    sep = ""
  ),
  caption = "Death Cases",
  icon = "fas fa-heart-broken",
  color = death_color
)
```

Row {data-width=400}
-----------------------------------------------------------------------
### **Daily Cumulative Cases** 
    
```{r}
plotly::plot_ly(data = df_msia_daily,
                x = ~ date,
                y = ~ active_cum, 
                name = 'Active', 
                fillcolor = active_color,
                type = 'scatter',
                mode = 'none', 
                stackgroup = 'one') %>%
  plotly::add_trace(y = ~ recovered_cum,
                    name = "Recovered",
                    fillcolor = recovered_color) %>%
  plotly::add_trace(y = ~ death_cum,
                    name = "Death",
                    fillcolor = death_color) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Cumulative Number of Cases"),
                 xaxis = list(title = "Date"),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```


### **Daily Cumulative Cases by State** 
```{r}
DT::datatable(df_state,rownames = FALSE, colnames = c('States', 'Total Confirmed Cases', 'New Cases', 'Deaths', 'Population'))
              
```


Row
-----------------------------------------------------------------------
### **Daily Cumulative Cases by Type (Malaysia only)** 
    
```{r}
plotly::plot_ly(data = df_msia_daily) %>%
  plotly::add_trace(
    x = ~date,
    y = ~confirmed_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Confirmed",
    line = list(color = confirmed_color),
    marker = list(color = confirmed_color)
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~death_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Death",
    line = list(color = death_color),
    marker = list(color = death_color)
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~active_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Active",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~recovered_cum,
    type = "scatter",
    mode = "lines+markers",
    name = "Recovered",
    line = list(color = recovered_color),
    marker = list(color = recovered_color)
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-01-25"),
    y = 1,
    text = paste("First case"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-03-17"),
    y = 3,
    text = paste("First death"),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -90,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-03-18"),
    y = 14,
    text = paste(
      "MCO"
    ),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-04-15"),
    y = 12,
    text = paste(
      "MCO x2"
    ),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-05-13"),
    y = 10,
    text = paste(
      "CMCO"
    ),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-06-10"),
    y = 8,
    text = paste(
      "RMCO"
    ),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = 30,
    ay = -90
  ) %>%
  plotly::add_annotations(
    x = as.Date("2020-09-01"),
    y = 6,
    text = paste(
      "RMCO x1"
    ),
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = 20,
    ay = -90
  ) %>%
  plotly::layout(
    title = "",
    yaxis = list(title = "Cumulative Number of Cases"),
    xaxis = list(title = "Date"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare"
  )
```


Plots
=======================================================================
Column {data-width=400}
-------------------------------------
### **Daily New Confirmed Cases (SEA)**
    
```{r}
daily_confirmed <- coronavirus %>%
  dplyr::filter(type == "confirmed") %>%
  dplyr::filter(date >= "2020-02-29") %>%
  dplyr::mutate(country = country) %>%
  dplyr::group_by(date, country) %>%
  dplyr::summarise(total = sum(cases)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = country, values_from = total)

#----------------------------------------
# Plotting the data

daily_confirmed %>%
  plotly::plot_ly() %>%
  plotly::add_trace(
    x = ~date,
    y = ~Malaysia,
    type = "scatter",
    mode = "lines+markers",
    name = "Malaysia"
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~Thailand,
    type = "scatter",
    mode = "lines+markers",
    name = "Thailand"
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~Indonesia,
    type = "scatter",
    mode = "lines+markers",
    name = "Indonesia"
  ) %>%
  plotly::add_trace(
    x = ~date,
    y = ~Singapore,
    type = "scatter",
    mode = "lines+markers",
    name = "Singapore"
  ) %>%
  plotly::layout(
    title = "",
    legend = list(x = 0.1, y = 0.9),
    yaxis = list(title = "Number of New Confirmed Cases"),
    xaxis = list(title = "Date"),
    hovermode = "compare",
    margin = list(
      b = 10,
      t = 10,
      pad = 2
    )
  )
```
 
### **Cases Distribution by Type (SEA)**

```{r daily_summary}
df_msia_ASIA <- coronavirus %>%
  dplyr::filter(country == "Malaysia" |
    country == "Thailand" |
    country == "Singapore" |
    country == "Indonesia" |
    country == "Brunei" |
    country == "Vietnam" |
    country == "Philippines" |
    country == "Cambodia") %>%
  dplyr::group_by(country, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(
    names_from = type,
    values_from = total
  ) %>%
  dplyr::mutate(unrecovered = confirmed - ifelse(is.na(recovered), 0, recovered) - ifelse(is.na(death), 0, death)) %>%
  dplyr::arrange(-confirmed) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(country = dplyr::if_else(country == "United Arab Emirates", "UAE", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "Mainland China", "China", country)) %>%
  dplyr::mutate(country = dplyr::if_else(country == "North Macedonia", "N.Macedonia", country)) %>%
  dplyr::mutate(country = trimws(country)) %>%
  dplyr::mutate(country = factor(country, levels = country))

plotly::plot_ly(
  data = df_msia_ASIA,
  x = ~country,

  y = ~ unrecovered,
  type = "bar",
  name = "Active",
  marker = list(color = active_color)
) %>%
  plotly::add_trace(
    y = ~recovered,
    name = "Recovered",
    marker = list(color = recovered_color)
  ) %>%
  plotly::add_trace(
    y = ~death,
    name = "Death",
    marker = list(color = death_color)
  ) %>%
  plotly::layout(
    barmode = "stack",
    yaxis = list(title = "Total cases"),
    xaxis = list(title = ""),
    hovermode = "compare",
    margin = list(
      b = 10,
      t = 10,
      pad = 2
    )
  )
```
Row
-------------------------------------

### **Daily New Death Cases in Malaysia**
    
```{r}
daily_confirmed <- coronavirus %>%
  dplyr::filter(type == "death") %>%
  dplyr::filter(date >= "2020-02-29") %>%
  dplyr::mutate(country = country) %>%
  dplyr::group_by(date, country) %>%
  dplyr::summarise(total = sum(cases)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = country, values_from = total)

#----------------------------------------
# Plotting the data

daily_confirmed %>%
  plotly::plot_ly() %>%
  plotly::add_trace(
    x = ~date,
    y = ~Malaysia,
    type = "scatter",
    mode = "lines+markers",
    line = list(color = death_color),
    marker = list(color = death_color),
    name = "Malaysia"
  ) %>%
  plotly::layout(
    title = "",
    yaxis = list(title = "Number of New Death Cases"),
    xaxis = list(title = "Date"),
    hovermode = "compare",
    margin = list(
      b = 10,
      t = 10,
      pad = 2
    )
  )
```

Satellite Overview
=======================================================================

### **Global Overview** (*Zoom In/Out*)
```{r}
library(leaflet)
library(leafpop)
library(purrr)
cv_data_for_plot <- coronavirus %>%
  dplyr::filter(cases > 0) %>%
  dplyr::group_by(country, province, lat, long, type) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()
cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$type)
pal <- colorFactor(c("orange", "red", "green"), domain = c("confirmed", "death", "recovered"))
map_object <- leaflet() %>% addProviderTiles(providers$Stamen.Toner)
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df_msia) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df_msia]],
        lng = ~long, lat = ~lat,
        color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df_msia]],
          feature.id = FALSE,
          row.numbers = FALSE,
          zcol = c("type", "cases", "country", "province")
        ),
        group = df_msia,
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      )
  })

map_object %>%
  addLayersControl(
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )
```
SIR Model
=======================================================================
```{r global, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(flexdashboard)
library(shiny)
library(dplyr)
library(DT)
library(ggplot2)
library(lubridate)
library(tidyr)
library(readr)
library(scales)
library(plotly)
library(glue)


options(shiny.error = browser)
##set date
filedate <- format(today() - days(1), "%m-%d-%Y")
if (file.exists("date-data-fetched.csv")) {
  fetch_date <- read_csv("date-data-fetched.csv")
} else {
  fetch_date <- tibble(date = date(ymd("2021-03-01")))
}
if (fetch_date$date != today()) {
  filename <- paste0("https://raw.githubusercontent.com/RamiKrispin/coronavirus/master/csv/coronavirus.csv")
  coronavirus <- read_csv(filename, col_types = cols(
    province = col_character(),
    country = col_character(),
    lat = col_double(),
    long = col_double(),
    date = col_date(format = ""),
    cases = col_double(),
    type = col_character()
  ))
  write_csv(coronavirus, here::here(paste0("data/", filedate, ".csv")))
  fetch_date$date <- today()
  write_csv(fetch_date, "date-data-fetched.csv")
}
coronavirus <- read_csv(here::here(paste0("data/", filedate, ".csv")), col_types = cols(
    province = col_character(),
    country = col_character(),
    lat = col_double(),
    long = col_double(),
    date = col_date(format = ""),
    cases = col_double(),
    type = col_character()
  ))

theme_set(theme_minimal())
##population data
un_country_list <- read_csv(here::here("UNdata_Export_20200316.csv"))
names(un_country_list) <- c("country", "year", "variant", "population")
un_country_list %>% filter(year == 2019)

coronavirus_countries <- coronavirus %>% 
  select(country) %>% 
  distinct(country)  ## for selecting a country

excluded_countries <- coronavirus_countries %>% 
  anti_join(un_country_list, by = c("country" = "country"))

countries_needing_translation <-read_csv(here::here("excluded_countries_dictionary.csv"))

select_countries <- c("All", coronavirus_countries, recursive = TRUE, use.names = FALSE)
select_countries <- tibble(select_countries) %>% 
  filter(select_countries != "Taiwan*" & select_countries != "Cruise Ship")
names(select_countries) <- c("country")
select_countries <- select_countries %>% 
  arrange(country)
full_countries <- select_countries %>% 
  left_join(countries_needing_translation, by = c("country")) %>% 
  mutate(UN_country = ifelse(is.na(UN_country), country, UN_country)) %>% 
  left_join(un_country_list, by = c("UN_country" = "country")) %>% 
  filter(year == "2019") 

## forecast function, can be improved

run_model <- function(f, population, duration, rnaught, drate, proj_duration) {

  ww_model <- f
  ww_model <- ww_model %>% 
    mutate(type = ifelse(type == "death", "deaths", type))
  
  ## extend the date by the prediction days
  
  ww_wide <- ww_model %>% 
    pivot_wider(names_from= type, values_from=c(cases, cumsum)) %>% 
    arrange(date)
  
  ww_date_range <- tibble(date =  ymd(seq(min(ww_wide$date), (max(ww_wide$date)), "days")))
  
  historic_range <- ww_date_range %>% 
    left_join(ww_wide, by = "date")
  
  historic_rows <- nrow(historic_range)
  
  ww_projection_dates <- tibble(date =  ymd(seq(min(ww_wide$date), (max(ww_wide$date) + proj_duration), "days")))
  
  ww_range <- ww_projection_dates %>% 
    left_join(ww_wide, by = "date")
  
  ## SIR Model
  ## New infections = (number of infectious people - deaths) * r0 / recovery_rate.
  ## New deaths = death_rate x infected people.
  ## New recoveries = number of infected people from 14 days ago - number of deaths
  ## New number of infected people = prior number of infected people + new infections - deaths - new recoveries
  ## initialize data
  fnew <- ww_range %>% 
  mutate(total_infections     = cumsum_infected,
         currently_infectious = total_infections,
         new_infections       = cases_infected,
         new_deaths           = cases_deaths,
         total_deaths         = cumsum_deaths,
         new_recoveries       = cases_recovered,
         total_recoveries     = cumsum_recovered,
         susceptible          = population - cumsum_infected - total_deaths,
         ds_dt                = 0,
         di_dt                = 0,
         dr_dt                = 0) %>% 
  replace_na(list(cases_infected       = 0,
                  cases_deaths         = 0,
                  cases_recovered      = 0,
                  cumsum_infected      = 0,
                  cumsum_deaths        = 0,
                  cumsum_recovered     = 0,
                  total_infections     = 0, 
                  currently_infectious = 0,
                  new_infections       = 0, 
                  new_deaths           = 0, 
                  total_deaths         = 0,
                  new_recoveries       = 0,
                  total_recoveries     = 0)) %>% 
  arrange(date)

## SIR model Parameters

  beta <- as.numeric(rnaught / duration)
  gamma <- as.numeric(1 / duration)

  daily_infection_probability <- rnaught / duration

   for (i in (historic_rows + 1):nrow(fnew)) {
    
    ## Let's calculate the SIR model derivatives
    
    fnew$ds_dt[i] <- round(-beta * fnew$currently_infectious[i - 1] * fnew$susceptible[i - 1] / population) - fnew$new_deaths[i - 1]
    fnew$di_dt[i] <- round(-fnew$ds_dt[i] - gamma * fnew$currently_infectious[i - 1])
    fnew$dr_dt[i] <- round(gamma * fnew$currently_infectious[i - 1])
    
    ## Now update the state with derivatives
    
    fnew$new_infections[i]       <-  ifelse (fnew$di_dt[i] < 0, 0, fnew$di_dt[i])
    fnew$currently_infectious[i] <-  fnew$currently_infectious[i - 1] + fnew$di_dt[i]
    fnew$new_deaths[i]           <-  round(fnew$currently_infectious[i - 1] * drate / duration)
    fnew$new_recoveries[i]       <-  fnew$dr_dt[i]
    fnew$susceptible[i]          <-  fnew$susceptible[i - 1]      + fnew$ds_dt[i]
    fnew$total_recoveries[i]     <-  fnew$total_recoveries[i - 1] + fnew$new_recoveries[i]
    fnew$total_deaths[i]         <-  fnew$total_deaths[i - 1]     + fnew$new_deaths[i]
    fnew$total_infections[i]     <-  fnew$total_infections[i - 1] + fnew$new_infections[i]
  }
  return(fnew)
}

```
Row {.sidebar}
------------------------

### SIR Model Parameters

**This model is not a perfect prediction of the future, but rather how COVID-19 might  affect us in the future.**

```{r input_siders, eval = TRUE}

selectInput(inputId = "country",
            label = "Country: ",
            choices = full_countries$country,
            selected = "Malaysia")
sliderInput(inputId = "percent_susceptible_population", 
            label = "Susceptible Population Percentage: ", 
            min = 0.01, max = 1.0, 
            value = 0.8)
sliderInput(inputId = "infection_duration", 
            label = "Days of Infection: ", 
            min = 2, max = 60, 
            value = 14)
sliderInput(inputId = "r0",
            label = "R(0) Value: ",
            min = 0.1, max = 10,
            value = 2.2, step = 0.1)
sliderInput(inputId = "death_rate",
            label = "Death Rate: ",
            min = 0.01, max = 1.0,
            value = 0.02, step = 0.01)
sliderInput(inputId = "projection_duration",
            label = "Prediction Duration (~1 Year): ",
            min = 10, max = 365,
            value = 180)

model_builder <- reactive({
  
  country_info <- full_countries %>% 
  filter(country == input$country) %>% 
  head(1)

  total_susceptible_population <- country_info$population * input$percent_susceptible_population * 1000
  
  if (input$country == "All") {
    df <- coronavirus %>%
      group_by(date, type) %>% 
      summarize(cases = sum(cases)) %>% 
      select(date,type,cases) %>% 
      arrange(date)
  } else {
    df <- coronavirus %>%
      filter(country == input$country) %>% 
      group_by(date, type) %>% 
      summarize(cases = sum(cases, na.rm = TRUE)) %>% 
      select(date,type,cases) %>% 
      arrange(date)
  }
  df <- df %>%
    group_by(type) %>% 
    arrange(type, date) %>% 
    mutate(cumsum = cumsum(cases)) %>% 
    ungroup()
  df <- df %>% 
    mutate(type = ifelse(type == "confirmed", "infected", type))
  run_model(df, total_susceptible_population, input$infection_duration,
            input$r0, input$death_rate, input$projection_duration)
})

```


```{r parameter_setting, eval = FALSE}
input <- tibble(percent_susceptible_population = 0.8,
infection_duration = 14,
r0 = 2.3,
death_rate = .02,
projection_duration = 300,
country = "Malaysia"
)

```


Row {data-height=700}
------------------------

### SIR Model

```{r model_math}

renderPlotly({

model_result <- model_builder()
  
final_values <- model_result %>% 
  filter(date == max(model_result$date)) %>% 
  head(n = 1)       ## in case we get multiple results


projection_long <- model_result %>% 
  pivot_longer(total_infections:total_recoveries)

max_infectious <- model_result %>% 
  filter(model_result$currently_infectious == max(model_result$currently_infectious)) %>% 
  head(n = 1)       ## in case we get multiple results

final_values <- model_result %>% 
  filter(date == max(model_result$date)) %>% 
  head(n = 1)       ## in case we get multiple results

max_plot_y_value <- max(projection_long$value) * 0.90
max_infection_text_x_value <- max_infectious$date - days(3)

country_info <- full_countries %>% 
  filter(country == input$country) %>% 
  head(1)
total_susceptible_population <- country_info$population * input$percent_susceptible_population * 1000
parameter_string <- glue("Susceptible population = {prettyNum(round(total_susceptible_population/1e6,1), big.mark = ',')}M, R0 = {input$r0}, infection duration = {input$infection_duration}, death rate = {input$death_rate}")

g <-ggplot(projection_long, aes(x = date, y = value, color = name, group = name)) +
  geom_point() +
  geom_line()
g <- g + scale_y_continuous(labels = unit_format(accuracy = 0.1, unit = "M", scale = 1e-6))
g <- g + scale_x_date(date_breaks = "2 weeks", limits = c(ymd("2020-01-22"), max(projection_long$date) + days(10)), date_labels = "%B %d",
               expand = expansion(0, 0.4))
g <- g +   annotate("segment", x = max_infectious$date, xend = max_infectious$date, y = 0, yend = max_plot_y_value * 0.9, color = "gray20",  linetype = "dotted")
g <- g +   annotate("text",  x = max_infection_text_x_value, y = max_plot_y_value, 
                    color = "gray20", size = 2.75,  hjust = "right", vjust = "inward",
                    label = paste0("Peak Infection\n",
                                   prettyNum(round(max_infectious$currently_infectious), big.mark = ","),
                                   "\non ", format(max_infectious$date, "%B %d")))
g <- g +   annotate("text", x = max_infection_text_x_value + days(30), y = final_values$total_deaths * 2.5, 
                    color = "gray20", size = 2.75, hjust = "inward", vjust = "inward",
           label = paste0("Total deaths\n", prettyNum(round(final_values$total_deaths), big.mark = ",")))
g <- g +   theme(axis.text.x = element_text(angle = 45, hjust = 1))
g <- g + labs(title = paste0(input$country, " COVID-19 Forecast"),
              caption = paste0(parameter_string, "\nData sources: Johns Hopkins University and Rami Krispin's coronavirus package"),
              x = "", y = "", color = "")
                             
ggplotly(g)

})

```

Prevention
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------


### Protect yourself and others from COVID-19

```{r}

valueBox(
  paste("WHO advice for Public")
  
)
```

Column
-----------------------------------------------------------------------
### **What to do to keep yourself and others safe from COVID-19**

**Maintain at least a 1-meter distance between yourself and others** to reduce your risk of infection when they cough, sneeze or speak. Maintain an even greater distance between yourself and others when indoors. The further away, the better.

**Make wearing a mask a normal part of being around other people. The appropriate use, storage and cleaning or disposal are  essential to make masks as effective as possible.**

Here are the basics of **how to wear a mask:**

- Clean your hands before you put your mask on, as well as before and after you take it off, and after you touch it at any time.

- Make sure it covers both your nose, mouth and chin.

- When you take off a mask, store it in a clean plastic bag, and every day either wash it if it’s a fabric mask, or dispose of a medical mask in a trash bin.

- Don’t use masks with valves.




### **How to make your environment safer**

**Avoid the 3Cs: spaces that are closed, crowded or involve close contact.**
- Outbreaks have been reported in restaurants, choir practices, fitness classes, nightclubs, offices and places of worship where people have gathered, often in crowded indoor settings where they talk loudly, shout, breathe heavily or sing.

- The risks of getting COVID-19 are higher in crowded and inadequately ventilated spaces where infected people spend long periods of time together in close proximity. These environments are where the virus appears to spread by respiratory droplets or aerosols more efficiently, so taking precautions is even more important.

**Meet people outside.** Outdoor gatherings are safer than indoor ones, particularly if indoor spaces are small and without outdoor air coming in.

**Avoid crowded or indoor settings** but if you can’t, then take precautions:

- **Open a window.** Increase the amount of ‘natural ventilation’ when indoors.



Column
-----------------------------------------------------------------------

### **Don’t forget the basics of good hygiene**
**Regularly and thoroughly clean your hands with an alcohol-based hand rub or wash them with soap and water.** This eliminates germs including viruses that may be on your hands.

**Avoid touching your eyes, nose and mouth.** Hands touch many surfaces and can pick up viruses. Once contaminated, hands can transfer the virus to your eyes, nose or mouth. From there, the virus can enter your body and infect you.

**Cover your mouth and nose with your bent elbow or tissue when you cough or sneeze.** Then dispose of the used tissue immediately into a closed bin and wash your hands. By following good ‘respiratory hygiene’, you protect the people around you from viruses, which cause colds, flu and COVID-19.

**Clean and disinfect surfaces frequently especially those which are regularly touched,** such as door handles, faucets and phone screens.


### **What to do if you feel unwell**

**Know the full range of symptoms of COVID-19.** The most common symptoms of COVID-19 are fever, dry cough, and tiredness. Other symptoms that are less common and may affect some patients include loss of taste or smell, aches and pains, headache, sore throat, nasal congestion, red eyes, diarrhoea, or a skin rash.

**Stay home and self-isolate even if you have minor symptoms such as cough, headache, mild fever,** until you recover. Call your health care provider or hotline for advice. Have someone bring you supplies. If you need to leave your house or have someone near you, wear a medical mask to avoid infecting others.

**If you have a fever, cough and difficulty breathing, seek medical attention immediately. Call by telephone first, if you can** and follow the directions of your local health authority.

**Keep up to date on the latest information from trusted sources, such as WHO or your local and national health authorities.** Local and national authorities and public health units are best placed to advise on what people in your area should be doing to protect themselves.


About
=======================================================================

**Epidemic Analysis**

The project requires student to develop an online data dashboard for providing a centralized, interactive
means of analyzing epidemic data, such as COVID-19. The dashboard is able to provide interactive
visualization means and epidemiological models for the users. Users will utilize the dashboard for
references and also understanding of current situation of epidemic.

**Objective**

- to provide a general-purpose epidemic analysis dashboard
- to enable forecasting of the epidemic based on the current data

**Data**

The input data for this dashboard is the dataset available from the [`{coronavirus}`](https://github.com/RamiKrispin/coronavirus){target="_blank"} R package. Make sure to download the development version of the package to have the latest data:

```
install.packages("devtools")
devtools::install_github("RamiKrispin/coronavirus")
```

The raw data is pulled from the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [repository](https://github.com/RamiKrispin/coronavirus-csv){target="_blank"}.

The data from Malaysia State is retrieved from UKK DOSM's daily update.



**Update**

The data is as of `r format(max(coronavirus$date), "%A %B %d, %Y")` and the dashboard has been updated on `r format(Sys.time(), "%A %B %d, %Y")`.


